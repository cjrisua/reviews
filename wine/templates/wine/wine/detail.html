{% extends "base.html" %}
{% load wine_tags %}
{% load crispy_forms_tags %}
{% block title %}Wine Region {% endblock %}
{% load humanize %}
{%block sidenavcontent %}
  <canvas class="mt-5" id="mixed-chart" width="800" height="450"></canvas>
{% endblock %}

{% block content %}
{% with context.market|first as item %}
    <p class="h4 mt-2 pt-1 mx-5">{{item.wine.producer.name}}</p>
    <p class="text-muted mx-5">{{item.wine.name}}</p>
    <dl class="row mx-5">
      <dt class="col-3">Score</dt>
      <dd class="col-9">{{context.score|floatformat:1}}</dd>
      <dt class="col-3">Country</dt>
      <dd class="col-9">{{item.wine.region.country}}</dd>
      <dt class="col-3">Region</dt>
      <dd class="col-9">{{item.wine.region}}</dd>
      <dt class="col-3">Average Price</dt>
      <dd class="col-9">$0.00</dd>
      <dt class="col-3">Vintage Region?</dt>
      <dd class="col-9">
        {%with context.vintagescore|first as vintage%}
            {{vintage.region}} ({{vintage.varietal.mastervarietal}})
        {%endwith%}
      </dd>
    </dl>
{%endwith%}
<div class="accordion mx-5" id="accordionExample">
    {% regroup context.market by id as grouped %}
    {% for group in grouped %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{forloop.counter}}">
            <button class="accordion-button{%if forloop.first%}{%else%} collapsed{%endif%}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{forloop.counter}}" aria-expanded="true" aria-controls="collapse{{forloop.counter}}">
                <div class="container">
                  {% with group.list|first as item %}  
                  <div class="row">
                        <div class="col-sm">
                            {{item.wine.name}}
                        </div>
                        <div class="col-sm">
                            {{item.year}}
                        </div>
                        <div class="col-sm">
                          {%with item.year|vintage_score:context.vintagescore as vintage_score%}
                          {{item.average_rating|floatformat:0}} <sup class="text-muted">{{item.average_rating|point_scoring:vintage_score}}</sup>
                          {%endwith%}
                      </div>
                        <div class="col-sm">
                          ${{item.price}}
                        </div>
                    {%endwith%}
                    </div>
                </div>
              </button>
        </h2>
        <div id="collapse{{forloop.counter}}" class="accordion-collapse collapse {%if forloop.first%}show{%endif%}" aria-labelledby="heading{{forloop.counter}}" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              {% for t in group.list %}
              <!--
              <figcaption class="blockquote-footer">
                {{t.user_critic}} <cite title="Source Title"></cite>
              </figcaption>-->
                <blockquote >
                  <p><strong>{{t.user_critic}}</strong><span class="text-muted"> {{t.user_score}}  </span><span class="h4 text-muted align-top"><sup> . </sup></span><small class="text-muted">{{t.user_issuedate}}</small></p>
                  <p >{{t.user_review}}</p>
                </blockquote>
                
                {%endfor%}
            </div>
          </div>
    </div>
    {%endfor%}
</div>
{{ context.data|json_script:"chart-data" }}
{% endblock %}

{% block  javascript %}
<script>
const data = JSON.parse(document.getElementById('chart-data').textContent);

new Chart(document.getElementById("mixed-chart"), {
  type: 'bar',
  data: data,
  options: {
    title: {
      display: true,
      text: 'Vintage Score'
    },
    legend: { display: false },
    scales: {
            yAxes: [{
                ticks: {
                    suggestedMin: 80,
                    suggestedMax: 100
                }
            }]
        }
  }
});
</script>

{% endblock %}