{% extends "base.html" %}
{% load wine_tags %}
{% load crispy_forms_tags %}
{% block title %}Registered {{section|title}} {% endblock %}

{%block sidenavcontent %}
    
    {% include "../main_sidebar.html" with inventory=inventory section=section %}
    {% terroir_treeview %}
    
{% endblock %}

{% block content %}
  {% include "./terroir_list.html" with inventory=inventory_object section=section %}
{% endblock %}

{% block  javascript %}
<script>
   function sitckysidebarselector() {

      if($('.bd-sidebar').height() <= $('#terroir-list').height()){
        /*$('.bd-sidebar').css("height","calc(100vh - 0rem");*/
        console.log("small list: " + $('.bd-sidebar').height() +" vs" + $('#terroir-list').height())
        /*$('.bd-sidebar').css("height","auto");*/
      }
      else{
        console.log("sidebar is  larger " + $('.bd-sidebar').height() +" vs" + $('#terroir-list').height())
      }
   }
   function hidden()
   {
       terroir_btn = $("div .terroir-action-show,.terroir-action");
       if($(terroir_btn).hasClass("terroir-action-show"))
          $(terroir_btn).toArray().forEach(e => e.style.zIndex="0");
       else
          $(terroir_btn).toArray().forEach(e => e.style.zIndex="");
       
   }
   function shownoshow(checkbox){
        if($(checkbox).is(':checked')){
            terroirdiv = $('div .terroir-action');
            $(terroirdiv).removeClass("terroir-action")
            $(terroirdiv).addClass("terroir-action-show")
        }
        else{
            terroirdiv = $('div .terroir-action-show');
            $(terroirdiv).removeClass("terroir-action-show")
            $(terroirdiv).addClass("terroir-action")
        }
   }
   $( document ).ready(function() {
    let selected_node = undefined;
     $('.treeview').mdbTreeview();
     const csrftoken = Cookies.get('csrftoken');
     var minlength = 3;
     var searchRequest = null;

     //var $bdsidebar = $('.bd-sidebar');
     //$bdsidebar.bind("DOMSubtreeModified", sitckysidebarselector);
     //var $terroirlist = $('#terroir-list');
     //$terroirlist.bind("DOMSubtreeModified", sitckysidebarselector);

     $(".terroir-action").bind("transitionend", hidden);
     $(".terroir-action-show").bind("transitionend", hidden);
     //$(document).bind('transitionend', ".terroir-action", hidden)
     //$(document).bind('transitionend', ".terroir-action-show", hidden)

     $(document).on('click','#customCheckAll',function(even){
        checked = $(this).is(':checked');
        ($('div .custom-checkbox,.terroir input')).toArray().forEach(function(i){
            $(i).prop('checked', checked)
        });
        shownoshow($(this))
     });
     $(document).on('click','input[name="terroirCheck"]',function(even){
        if(!$('#customCheckAll').is(':checked'))
           shownoshow($(this))
        
     });
     $("#searchItem").on('keyup',function(){
      var that = this,
          value = $(this).val();
          if (value.length >= minlength ) {
            //if (searchRequest != null){
            //    console.log("aborted!")
            //    searchRequest.abort();
            //}
            //searchRequest = 
            $.ajax({
                type: "GET",
                url: "/wine/inventory/terroir/",
                //contentType: "application/json; charset=utf-8", 
                //async: false,
                dataType: 'JSON',
                headers:{"X-CSRFToken": csrftoken},
                data: {
                    'name' : value
                },
                dataType: "text",
                success: function(msg){
                    $("#terroir-list").html($(msg).find('#terroir-list')[0].innerHTML)
                    $(".terroir-action").bind("transitionend", hidden);
                    $(".terroir-action-show").bind("transitionend", hidden);
                }
            }).done(function(){
               console.log("done!")
            });
          }
     });
     $(document).on('drop','.droppable', function(event){
            var data = event.originalEvent.dataTransfer.getData("text");
            event.target.parentNode.parentNode.parentNode.parentNode.lastElementChild.appendChild(document.getElementById(data))
            //event.target.parentNode.parentNode.parentNode.lastElementChild.appendChild(document.getElementById(data));
            data = JSON.stringify({parentterroir: $(this)[0].parentNode.parentNode.id})
            console.log(data)
            
            $.ajax({
                    type: "PATCH",
                    url: "/api/terroir/"+selected_node+"/",
                    data: data,
                    contentType: "application/json; charset=utf-8", 
                    headers:{"X-CSRFToken": csrftoken},
                    dataType: "json",
                    success: successCallback
                });
                function successCallback(response) {
                        console.log("Update Done!")
                }
        });
     $(document).on('dragover','.droppable', function(event){
            event.preventDefault();
            let over_id = $(this)[0].parentNode.parentNode.id;
            console.log(selected_node + " dragged over " + $(this).find('a')[0].innerText +" ["+over_id+"]")
        });
     $(document).on('dragstart','.draggable', function(event){
            selected_node = $(this)[0].parentNode.parentNode.id
            console.log("dragstart " + selected_node);
            event.originalEvent.dataTransfer.setData("text",selected_node);
        });
     $(document).on('click', '.wr-is-clickable', function(){
        let parent_content = $(this)[0].nextElementSibling
        let nested_active_node =$($(this)[0].parentNode).find(".nested")[0]

        if (!$(this).hasClass("stage-up") && !$(this).hasClass("stage-down")){
            if ($(this).hasClass("down"))
                $($(this)[0]).addClass("stage-down");
            else{
                $($(this)[0]).addClass("stage-down");
                $($(this)[0]).addClass("down");
            }
        }
        else{
            if (!$(this).hasClass("down") && $(this).hasClass("stage-down")){
                $($(this)[0]).removeClass("stage-down");
                $($(this)[0]).addClass("stage-up");
                $(nested_active_node).removeClass('active')
            }
            else if ($(this).hasClass("down") && $(this).hasClass("stage-down")){
                $($(this)[0]).addClass("stage-up");
                $($(this)[0]).removeClass("down");
                $($(this)[0]).removeClass("stage-down");
                $(nested_active_node).removeClass('active')
            }
            else if (!$(this).hasClass("down") && $(this).hasClass("stage-up")){
                $($(this)[0]).removeClass("stage-up");
                $($(this)[0]).addClass("stage-down");
                $($(this)[0]).addClass("down");
            }
            else if ($(this).hasClass("down") && $(this).hasClass("stage-up"))
            {
                $($(this)[0]).removeClass("stage-up");
                $($(this)[0]).addClass("stage-down");
                $(nested_active_node).removeClass('active')
            }
            else
            {
                print("????")
            }
        }
        if ($(this).hasClass("down")){
            $(nested_active_node).removeClass('d-none')
            $(parent_content).find('i').removeClass('rotate-bottle')
            $.ajax({
                url: "/api/terroir/",
                type: 'get',
                dataType: "json",
                data: {
                  parentterroir: $(this)[0].parentNode.id
                },
                success: successCallback
            });
        }
        else{
          $(nested_active_node).addClass('d-none')
          $(parent_content).find('i').addClass('rotate-bottle')
        }
        function successCallback(response) {
            if (!$(nested_active_node).hasClass('active'))
                $(nested_active_node).addClass('active')
            $(nested_active_node).empty()
            subregions = $.map( response.results, function( item ) {
                            //console.log(Boolean(item.with_subterroir))
                            return '<li id="'+item.id+'" class="tree-item">'+(item.with_subterroir == "True" ?'<i class="fas fa-angle-right rotate wr-is-clickable"></i>':'')+'<span><i class="fas fa-wine-bottle rotate-bottle ic-w mx-1 draggable" draggable="true"></i><span class="droppable"><a href="#" class="click-region-name"><small>'+item.name+'</small></a></span></span><ul class="nested"></ul></li>'
                          });
            $(nested_active_node).append(subregions)
          }
     });
     $(document).on('click', '.click-region-name', function(event, action){
            event.preventDefault();
            //let terroirid = $(this)[0].parentNode.parentNode.parentNode.id
            let terroirid = $(this)[0].id;
            $('div #terroir-list').empty()
            $.ajax({
                url: "/wine/inventory/terroir/"+terroirid+"/",
                type: 'get',
                success: successCallback
            });
            function successCallback(response) {
                $('div #terroir-list').html($(response).html())
                $(".terroir-action").bind("transitionend", hidden);
                $(".terroir-action-show").bind("transitionend", hidden);
            }

            /*
            let region_array = Array();
            let data = JSON.stringify({id: $(this)[0].parentNode.parentNode.parentNode.id})
            let name = $(this)[0].parentNode.parentNode.parentNode;
            console.log('Data: '  + data)
            function GetParentName(nodename){
                if ($(nodename)[0].parentNode.parentNode.parentNode.parentNode.parentNode.id != ""){   
                    region_array.push($(nodename)[0].innerText)
                    new_nodename = $(nodename)[0].parentNode.parentNode.parentNode.parentNode.parentNode;
                    GetParentName($(new_nodename).find('.click-region-name')[0])
                }
                else
                    region_array.push($(nodename)[0].innerText)

            }
            if ($("[name=child-terroirs")[0] != undefined)
                $("[name=child-terroirs")[0].remove()

            $.ajax({
                    type: action == "action-remove" ? "DELETE": "POST",
                    url: "wine/inventory/terroir/2/",
                    data: data,
                    contentType: "application/json; charset=utf-8", 
                    async: false,
                    headers:{"X-CSRFToken": csrftoken},
                    success: function successCallback(response){
                        divholder = $("#region-form")[0].parentNode
                        $("#region-form").remove()
                        divholder.append($(response).find('#region-form')[0])
                        GetParentName($(name).find('.click-region-name')[0])
                        $('#region-path-info').html(region_array.reverse().join(" > "))
                        
                        console.log("??" + $("#traverse").val())
                        //GetRegions(64173)
                        dropdowntext = $("#traverse").val()
                        if($("#traverse").val() == "None")
                            GetRegions($("#terroirid").val())

                        $("#id_region").empty()
                        $("#id_region").append("<option value='"+$("#terroirid").val()+"' selected>"+dropdowntext+"</option>"); // + "["+start+"]")

                        vineyards = $(response).filter('[name=child-terroirs]')  
                        if( $(vineyards)[0] != undefined)                
                            divholder.append($(vineyards)[0])
                        
                    },
                    error: function (textStatus, errorThrown) {
                         console.log("error")
                         console.log(textStatus)
                         console.log(errorThrown)
                    }
                });
                function successCallback(response) {
                    console.log("Done!")
                }*/
        });
     $(document).on('show.bs.modal','#RelocateTerroirModal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        //var recipient = button.data('whatever') // Extract info from data-* attributes
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this)
        //modal.find('.modal-title').text('New message to ')
        //modal.find('.modal-body input').val(recipient)
     });
  });
</script>
 
{% endblock %}















